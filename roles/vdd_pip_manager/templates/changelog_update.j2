{# Split at the “Unreleased” marker #}
{%- set parts = existing_changelog.split('## [Unreleased]') -%}
{%- set header = parts[0] -%}
{%- set tail  = parts|length > 1 and parts[1] or '' -%}

{# Remove any prior block for this exact release_version #}
{%- set pattern    = '(?sm)^## \\[' ~ config_global.release_version ~ '\\].*?(?=^## \\[|$)' -%}
{%- set tail_clean = tail | regex_replace(pattern, '') -%}

{# 1) Header + Unreleased #}
{% if header == '' %}
# Changelog

All notable changes to this project will be documented in this file.

## [Unreleased]
{% else %}
{{ header.rstrip() }}
## [Unreleased]
{% endif %}

{# 2) New release block #}
## [{{ config_global.release_version }}] - {{ config_global.release_date }}
{% if changed_dependencies %}
### Changed
{% for pkg in changed_dependencies %}
- Updated: {{ pkg.name }} → {{ pkg.version }}
{% endfor %}
{% else %}
*(no changes detected)*
{% endif %}

{# 3) The rest (all older releases, minus the removed duplicate) #}
{{ tail_clean }}