---
- name: Categorize and report dependencies
  hosts: localhost
  gather_facts: false
  vars_files:
    - dependency_config.json

  vars:
    pom_file: "./pom.xml"
    pom_ns: "http://maven.apache.org/POM/4.0.0"
    debug_mode: false

  tasks:
    - name: Fail if pom.xml does not exist
      stat:
        path: "{{ pom_file }}"
      register: pom_stat

    - name: Abort if pom.xml does not exist
      fail:
        msg: "{{ pom_file }} does not exist"
      when: not pom_stat.stat.exists

    - name: Update properties in pom.xml from config
      community.general.xml:
        path: "{{ pom_file }}"
        xpath: "//pom:properties/pom:{{ item.key }}"
        namespaces:
          pom: "{{ pom_ns }}"
        value: "{{ item.value }}"
        pretty_print: true
      loop: "{{ global.properties | dict2items }}"
      when:
        - global.properties is defined

    - name: Update dependency versions in pom.xml
      community.general.xml:
        path: "{{ pom_file }}"
        xpath: "//pom:dependency[pom:artifactId='{{ item.artifactId }}']/pom:version"
        namespaces:
          pom: "{{ pom_ns }}"
        value: "{{ item.version }}"
        pretty_print: true
      loop: "{{ global.dependencies }}"
      when:
        - global.dependencies is defined
        - item.artifactId is defined
        - item.version is defined

    - name: Update build plugin versions in pom.xml
      community.general.xml:
        path: "{{ pom_file }}"
        xpath: "//pom:plugin[pom:artifactId='{{ item.artifactId }}']/pom:version"
        namespaces:
          pom: "{{ pom_ns }}"
        value: "{{ item.version }}"
        pretty_print: true
      loop: "{{ global.build_plugins }}"
      when:
        - global.build_plugins is defined
        - item.artifactId is defined
        - item.version is defined

    - name: Check for existing changelog entry
      stat:
        path: "CHANGELOG.md"
      register: changelog_stat

    - name: Read existing changelog
      slurp:
        path: "CHANGELOG.md"
      register: changelog_content
      when: changelog_stat.stat.exists

    - name: Generate new changelog entry
      set_fact:
        new_entry: |
          ## [{{ global.release_version }}] - {{ global.release_date }}

          {% if global.dependencies | length > 0 or global.build_plugins | length > 0 or global.properties | length > 0 %}
          ### Summary
          {% if global.dependencies | length > 0 %}
          - Updated {{ global.dependencies | length }} dependencies
          {% endif %}
          {% if global.build_plugins | length > 0 %}
          - Updated {{ global.build_plugins | length }} build plugins
          {% endif %}
          {% if global.properties | length > 0 %}
          - Updated {{ global.properties | length }} properties
          {% endif %}
          {% endif %}

          {% if global.dependencies | length > 0 %}
          ### Dependencies
          {% for dep in global.dependencies %}
          - Updated `{{ dep.artifactId }}` to version `{{ dep.version }}`
          {% endfor %}
          {% endif %}

          {% if global.build_plugins | length > 0 %}
          ### Build Plugins
          {% for plugin in global.build_plugins %}
          - Updated `{{ plugin.artifactId }}` to version `{{ plugin.version }}`
          {% endfor %}
          {% endif %}

          {% if global.properties | length > 0 %}
          ### Properties
          {% for key, value in global.properties.items() %}
          - Updated `{{ key }}` to `{{ value }}`
          {% endfor %}
          {% endif %}

          [{{ global.release_version }}]: {{ lookup('env', 'CI_PROJECT_URL') }}/-/compare/v{{ global.release_version }}...HEAD
      when:
        - global.release_version is defined
        - global.release_date is defined
        - not changelog_stat.stat.exists or 
          (changelog_stat.stat.exists and 
           global.release_version not in changelog_content.content | b64decode)

    - name: Create or update changelog
      copy:
        dest: "CHANGELOG.md"
        content: |
          # Changelog

          All notable changes to this project will be documented in this file.

          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

          {% if new_entry is defined %}
          {{ new_entry }}

          {% endif %}
          {% if changelog_stat.stat.exists %}
          {{ changelog_content.content | b64decode | regex_replace('(?s)^# Changelog.*?Semantic Versioning.*?\n\n', '') | regex_replace('# BEGIN ANSIBLE MANAGED BLOCK.*?\n', '') | regex_replace('# END ANSIBLE MANAGED BLOCK.*?\n', '') }}
          {% endif %}
        force: yes
      when:
        - global.release_version is defined
        - global.release_date is defined